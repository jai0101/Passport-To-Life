<%- include('cabecalho') -%>

<section id="portfolio" class="portfolio" style="background-color: #fffcf7;">
  <div class="container py-5" data-aos="fade-up">

    <!-- üß† Cabe√ßalho da se√ß√£o -->
    <div class="section-header mb-4 text-center">
      <h2 style="color:#b56e56;">Materiais de <%= disciplina %></h2>
      <p>Veja os conte√∫dos compartilhados por outros usu√°rios.</p>
    </div>

    <!-- üîé FILTRO DE BUSCA -->
    <form method="get" action="/visualiza/<%= disciplina %>" class="d-flex justify-content-center mb-5">
      <input
        type="text"
        name="busca"
        class="form-control me-2"
        style="max-width: 350px;"
        placeholder="Buscar por t√≠tulo..."
        value="<%= busca || '' %>"
      >
      <button type="submit" class="btn btn-outline-dark">
        <i class="bi bi-search"></i> Buscar
      </button>
    </form>

    <!-- ‚ö†Ô∏è CASO N√ÉO TENHA RESULTADOS -->
    <% if (!materiais || materiais.length === 0) { %>
      <div class="text-center mt-5">
        <h4 style="color: #b56e56;">Nenhum material encontrado para esta disciplina.</h4>
      </div>
    <% } else { %>

      <!-- üß© GRID DE CARDS -->
      <div class="row justify-content-center">
        <% materiais.forEach(material => { %>
          <% 
            const extensao = material.material.split('.').pop().toLowerCase();
            const extensoesImagem = ['jpg', 'jpeg', 'png', 'webp', 'gif', 'jfif'];
            const urlArquivo = `/assets/fotos/${material.material}`;
          %>

          <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
            <div class="card shadow-sm h-100 border-0" style="border-radius: 15px; overflow: hidden;">

              <!-- üñºÔ∏è PR√â-VISUALIZA√á√ÉO -->
              <% if (extensoesImagem.includes(extensao)) { %>
                <img 
                  src="<%= urlArquivo %>" 
                  class="card-img-top" 
                  alt="Material de <%= material.titulo %>" 
                  style="height: 200px; object-fit: cover;"
                >
              <% } else if (extensao === 'pdf') { %>
                <iframe 
                  src="<%= urlArquivo %>#toolbar=0" 
                  class="w-100" 
                  style="height: 200px; border: none;" 
                  title="Pr√©via do PDF">
                </iframe>
              <% } else if (['ppt', 'pptx'].includes(extensao)) { %>
                <iframe 
                  src="https://view.officeapps.live.com/op/embed.aspx?src=<%= encodeURIComponent(baseUrl + urlArquivo) %>" 
                  class="w-100" 
                  style="height: 200px; border: none;" 
                  title="Pr√©via do PowerPoint">
                </iframe>
              <% } else { %>
                <div class="d-flex align-items-center justify-content-center bg-light text-muted" style="height: 200px; font-size: 0.9rem;">
                  <i class="bi bi-file-earmark-text" style="font-size: 1.5rem; margin-right: 6px;"></i>
                  Pr√©via n√£o dispon√≠vel
                </div>
              <% } %>

              <!-- üí¨ CONTE√öDO -->
              <div class="card-body d-flex flex-column justify-content-between">
                <div>
                  <h5 class="card-title" style="color:#b56e56;"><%= material.titulo %></h5>
                  <p class="card-text text-muted" style="font-size: 0.9rem;">
                    <%= material.conteudo.length > 100 ? material.conteudo.substring(0, 100) + '...' : material.conteudo %>
                  </p>
                </div>

                <!-- üîò BOT√ïES -->
                <div class="mt-3 d-flex justify-content-between gap-2">
                  <a href="/material/visualizar/<%= material._id %>" target="_blank" class="btn btn-sm btn-outline-success w-50">
                    <i class="bi bi-eye"></i> Visualizar
                  </a>
                  <a href="/material/download/<%= material._id %>" class="btn btn-sm btn-outline-primary w-50">
                    <i class="bi bi-download"></i> Baixar
                  </a>
                </div>

                <div class="mt-2">
                  <% if (userLogado) { %>
                    <a href="/perfil/<%= material.usuario._id %>" class="btn btn-sm btn-outline-secondary w-100">
                      <i class="bi bi-person-circle"></i> Ver perfil do autor
                    </a>
                  <% } else { %>
                    <a href="/login?error=√â necess√°rio estar logado para ver o perfil do autor" class="btn btn-sm btn-outline-secondary w-100">
                      <i class="bi bi-person-circle"></i> Ver perfil do autor
                    </a>
                  <% } %>
                </div>
              </div>
            </div>
          </div>

        <% }) %>
      </div>
    <% } %>
  </div>
</section>

<%- include('rodape') -%>
