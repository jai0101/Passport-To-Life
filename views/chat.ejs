<div id="chat-container">
    <% if (user) { %>
        <ul id="messages"></ul>
        <form id="form" action="" style="display: flex; gap: 6px; padding: 6px;">

            <!-- Campo de Apelido editável -->
            <input 
                id="nickname" 
                autocomplete="off" 
                placeholder="Seu Apelido" 
                style="width: 120px; flex-grow: 0;" 
                value="<%= user.username || user.nome %>"
            />

            <!-- Campo de Mensagem -->
            <input id="input" autocomplete="off" placeholder="Digite sua mensagem..." style="flex: 1;" />

            <button type="submit">Enviar</button>
        </form>

    <% } else { %>
        <div id="login-message">
            Para enviar mensagens no Chat, faça seu <a href="/login">Login</a>.
        </div>
    <% } %>
</div>

<script src="/socket.io/socket.io.js"></script>

<% if (user) { %>
<script>
    const socket = io();
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const nicknameInput = document.getElementById('nickname');
    const messages = document.getElementById('messages');

    form.addEventListener('submit', (e) => {
        e.preventDefault();

        const nickname = nicknameInput.value.trim();
        const message = input.value.trim();

        if (!nickname) {
            alert("Escolha um apelido antes de enviar a mensagem!");
            return;
        }

        if (message) {
            socket.emit('chat message', { nickname: nickname, msg: message });
            input.value = '';
        }
    });

    socket.on('chat message', (data) => {
        const item = document.createElement('li');
        const nicknameSpan = document.createElement('span');
        nicknameSpan.classList.add('nickname');
        nicknameSpan.textContent = data.nickname + ': ';
        item.appendChild(nicknameSpan);
        item.appendChild(document.createTextNode(data.msg));
        messages.appendChild(item);
        messages.scrollTop = messages.scrollHeight;
    });
</script>
<% } %>
